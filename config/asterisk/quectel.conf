; Homenichat chan_quectel Configuration
; Production-tested configuration for SIM7600/EC25 GSM modems
;
; CRITICAL NOTES:
; 1. This config is auto-generated by Homenichat during setup wizard
; 2. NEVER access serial ports directly while Asterisk is running (causes SEGFAULT)
; 3. EC25 modems use UAC audio mode (USB Audio Class) - NOT serial TTY
; 4. SIM7600 modems use TTY audio mode (serial port)
;
; MODEM TYPE → FORK:
;   EC25    → IchthysMaranatha fork (quec_uac=1 for VoLTE audio)
;   SIM7600 → RoEdAl fork @ 37b566f (slin16=yes for 16kHz audio)
;
; Copy this file to /etc/asterisk/quectel.conf and adjust device paths

[general]
interval=15                    ; Status check interval (seconds)
smsdb=/var/lib/asterisk/smsdb  ; SMS database directory
csmsttl=600                    ; Concatenated SMS TTL (seconds)

[defaults]
context=from-gsm               ; Default dialplan context for incoming calls
group=0                        ; Device group (used by dialplan: Quectel/g0/number)
autodeletesms=no               ; Keep SMS for debugging (set yes in production)
resetquectel=yes               ; Reset modem on critical errors
usecallingpres=yes
callingpres=allowed_passed_screen

; DTMF detection - DO NOT use dtmf=relax (causes SEGFAULT)
; Only valid values are: yes, no
; Default (absent) works best for most setups

; =====================================================
; EC25 MODEM EXAMPLE (VoLTE with UAC audio)
; =====================================================
; Uses IchthysMaranatha fork of chan_quectel
; Audio via USB Audio Class (NOT serial TTY)
;
; IMPORTANT: EC25 requires AT commands at runtime (do NOT persist after reboot):
;   AT+QAUDMOD=3    → USB Audio mode (OBLIGATORY for VoLTE audio!)
;   AT+QPCMV=1,2    → Voice over UAC
; These are auto-applied by modem-init.sh / WatchdogService after startup.

;[hni-ec25]
;data=/dev/ttyUSB2              ; AT command port
;quec_uac=1                    ; USB Audio Class mode (REQUIRED for EC25 VoLTE!)
;alsadev=plughw:CARD=Android,DEV=0  ; ALSA device for UAC audio
;context=from-gsm
;slin16=no                     ; EC25 UAC = 8kHz audio
;rxgain=10                     ; Adjust for your setup
;txgain=10                     ; Adjust for your setup

; =====================================================
; SIM7600 MODEM EXAMPLE (TTY serial audio)
; =====================================================
; Uses RoEdAl fork @ commit 37b566f of chan_quectel
; Audio via serial port (TTY mode)
;
; Audio gain settings PREVENT TX saturation:
;   rxgain: GSM network → Asterisk (-6 to +6 dB, recommended: -5)
;   txgain: Asterisk → GSM network (recommended: -18 for SIM7600)

;[hni-sim7600]
;data=/dev/ttyUSB2              ; AT command port
;audio=/dev/ttyUSB4             ; Audio/PCM port (SIM7600: USB+4)
;context=from-gsm
;slin16=yes                     ; 16kHz audio (REQUIRED for SIM7600)
;rxgain=-5                      ; Prevents clipping on loud callers
;txgain=-18                     ; CRITICAL: prevents SIM7600 TX saturation

; =====================================================
; UDEV RULES FOR PERSISTENT DEVICE NAMES
; =====================================================
; Create /etc/udev/rules.d/99-gsm-modems.rules:
;
; # SIM7600 Modem on USB bus 2-1
; SUBSYSTEM=="tty", KERNEL=="ttyUSB*", KERNELS=="2-1:1.2", SYMLINK+="gsm-modem1-at", MODE="0666"
; SUBSYSTEM=="tty", KERNEL=="ttyUSB*", KERNELS=="2-1:1.4", SYMLINK+="gsm-modem1-audio", MODE="0666"
;
; # EC25 Modem on USB bus 2-1 (no audio symlink needed - uses ALSA)
; SUBSYSTEM=="tty", KERNEL=="ttyUSB*", KERNELS=="2-1:1.2", SYMLINK+="gsm-modem1-at", MODE="0666"
;
; Then reload: udevadm control --reload && udevadm trigger

; =====================================================
; TROUBLESHOOTING
; =====================================================
;
; Modem not detected:
;   1. Check USB: lsusb | grep -E "1e0e|2c7c"
;   2. Check ports: ls -la /dev/ttyUSB*
;   3. Reload module: asterisk -rx "module reload chan_quectel.so"
;
; EC25 "Voice: No" or no audio:
;   1. Ensure quec_uac=1 in quectel.conf (NOT audio=/dev/ttyUSB1)
;   2. Check AT commands applied: asterisk -rx "quectel cmd MODEM AT+QAUDMOD?"
;      → Must return 3 (USB Audio mode)
;   3. Re-apply: asterisk -rx "quectel cmd MODEM AT+QAUDMOD=3"
;                asterisk -rx "quectel cmd MODEM AT+QPCMV=1,2"
;   4. Check ALSA card: aplay -l | grep Android
;
; SIM7600 audio saturated/distorted:
;   1. Increase txgain attenuation: try -18 or -20
;   2. Apply AT commands: AT+CMICGAIN=0, AT+CTXVOL=0x0100
;   3. Check softphone input gain settings
;
; Asterisk crashes (SEGFAULT):
;   1. NEVER access /dev/ttyUSB* directly while Asterisk runs
;   2. Use only: asterisk -rx "quectel cmd MODEM AT+CSQ"
;   3. Clear SMS database: rm -rf /var/lib/asterisk/smsdb/*
;
; SMS not working:
;   1. Remove msg_storage and msg_direct settings (use defaults)
;   2. Check dialplan: asterisk -rx "dialplan show from-gsm"
;   3. Check modem: asterisk -rx "quectel show devices"
;   4. Watch logs: tail -f /var/log/asterisk/full | grep -i sms
