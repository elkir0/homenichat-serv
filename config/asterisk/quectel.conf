; Homenichat chan_quectel Configuration
; Production-tested configuration for SIM7600/EC25 GSM modems
;
; CRITICAL NOTES:
; 1. This config has been tested in production for 10+ days without issues
; 2. Audio gain settings PREVENT TX (microphone) saturation on SIM7600
; 3. NEVER access serial ports directly while Asterisk is running (causes SEGFAULT)
; 4. Use only RoEdAl fork commit 37b566f of chan_quectel
;
; Copy this file to /etc/asterisk/quectel.conf and adjust device paths

[general]
interval=15                    ; Status check interval (seconds)
smsdb=/var/lib/asterisk/smsdb  ; SMS database directory
csmsttl=600                    ; Concatenated SMS TTL (seconds)

[defaults]
context=from-gsm               ; Default dialplan context for incoming calls
group=0                        ; Device group for load balancing

; =====================================================
; AUDIO GAIN SETTINGS - Critical for SIM7600
; =====================================================
; Without these settings, TX audio will be saturated/distorted
;
; rxgain: GSM network → Asterisk (speaker/incoming audio)
;   Range: -6 to +6 dB
;   Recommended: -5 (prevents clipping on loud callers)
rxgain=-5

; txgain: Asterisk → GSM network (microphone/outgoing audio)
;   Range: -6 to +6 dB
;   Recommended: -15 (CRITICAL: prevents SIM7600 TX saturation)
;   If still saturated: try -18 or -20
txgain=-15

; =====================================================
; SMS Settings (Production-tested)
; =====================================================
autodeletesms=yes              ; Delete SMS after processing
resetquectel=yes               ; Reset modem on critical errors
msg_storage=me                 ; Store in modem memory (NOT SIM - avoids saturation)
msg_direct=off                 ; Storage mode (direct mode unreliable on SIM7600)

; DTMF detection - DO NOT use dtmf=relax (causes SEGFAULT)
; Only valid values are: yes, no
; Default (absent) works best for most setups

; =====================================================
; MODEM DEFINITIONS
; =====================================================
; Uncomment and configure based on your hardware
;
; Finding device paths:
;   dmesg | grep ttyUSB
;   ls -la /dev/ttyUSB*
;
; SIM7600 typically uses:
;   - ttyUSB2 for AT commands (interface 1.2)
;   - ttyUSB4 for audio/PCM (interface 1.4)
;
; For stable paths, create udev rules (see bottom of file)

;[modem-1]
;data=/dev/ttyUSB2              ; AT command port
;audio=/dev/ttyUSB4             ; Audio/PCM port
;context=from-gsm               ; Dialplan context
;slin16=yes                     ; 16kHz audio (REQUIRED for SIM7600)
;txgain=-15                     ; Per-modem override if needed
;imsi=340090000000000           ; Optional: SIM IMSI

;[modem-2]
;data=/dev/ttyUSB7
;audio=/dev/ttyUSB9
;context=from-gsm
;slin16=yes
;txgain=-18                     ; Osteo modem needs more attenuation

; =====================================================
; AT COMMANDS FOR AUDIO OPTIMIZATION
; =====================================================
; These commands are applied at runtime by configure-gsm-audio.sh
; or can be added to a watchdog script:
;
; AT+CPCMFRM=1      ; Set audio sample rate to 16kHz (matches slin16=yes)
; AT+CMICGAIN=0     ; Microphone gain minimum (0-7, 0=quietest)
; AT+CTXVOL=0x0200  ; TX volume reduced (hex, lower=quieter)
; AT+COUTGAIN=5     ; Speaker/RX gain (0-5, 5=loudest)
;
; Execute via Asterisk CLI:
;   asterisk -rx "quectel cmd modem-1 AT+CMICGAIN=0"

; =====================================================
; UDEV RULES FOR PERSISTENT DEVICE NAMES
; =====================================================
; Create /etc/udev/rules.d/99-gsm-modems.rules:
;
; # SIM7600 Modem 1 on USB bus 2-1
; SUBSYSTEM=="tty", KERNEL=="ttyUSB*", KERNELS=="2-1:1.2", SYMLINK+="gsm-modem1-at", MODE="0666"
; SUBSYSTEM=="tty", KERNEL=="ttyUSB*", KERNELS=="2-1:1.4", SYMLINK+="gsm-modem1-audio", MODE="0666"
;
; # SIM7600 Modem 2 on USB bus 2-2
; SUBSYSTEM=="tty", KERNEL=="ttyUSB*", KERNELS=="2-2:1.2", SYMLINK+="gsm-modem2-at", MODE="0666"
; SUBSYSTEM=="tty", KERNEL=="ttyUSB*", KERNELS=="2-2:1.4", SYMLINK+="gsm-modem2-audio", MODE="0666"
;
; Then reload: udevadm control --reload && udevadm trigger
;
; And use:
;   data=/dev/gsm-modem1-at
;   audio=/dev/gsm-modem1-audio

; =====================================================
; TROUBLESHOOTING
; =====================================================
;
; Modem not detected:
;   1. Check USB: lsusb | grep -E "1e0e|2c7c"
;   2. Check ports: ls -la /dev/ttyUSB*
;   3. Reload module: asterisk -rx "module reload chan_quectel.so"
;
; Audio saturated/distorted:
;   1. Increase txgain attenuation: try -18 or -20
;   2. Apply AT commands: AT+CMICGAIN=0, AT+CTXVOL=0x0100
;   3. Check softphone input gain settings
;
; Asterisk crashes (SEGFAULT):
;   1. NEVER access /dev/ttyUSB* directly while Asterisk runs
;   2. Use only: asterisk -rx "quectel cmd modem-1 AT+CSQ"
;   3. Clear SMS database: rm -rf /var/lib/asterisk/smsdb/*
;
; SMS not working:
;   1. Verify msg_storage=me (not sm)
;   2. Try: asterisk -rx "quectel sms direct on modem-1"
;   3. Check: asterisk -rx "quectel sms list all modem-1"
