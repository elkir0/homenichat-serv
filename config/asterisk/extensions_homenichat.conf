; Homenichat Custom Dialplan
; Include this file in extensions.conf: #include extensions_homenichat.conf
;
; This dialplan provides:
; - Internal extension calling (1XXX)
; - Outbound calls via GSM modems (chan_quectel)
; - Test extensions (600-602)
;
; MODEM DIALING: Uses Quectel/g0/ (group 0) to dial any available modem.
; All modems in quectel.conf default to group=0, so this works regardless
; of modem name (modem-1, hni-ec25, etc.)
;
; AUDIO FIX: VOLUME(TX)=-20 attenuates WebRTC signal to prevent
; saturation when bridging to GSM modem

[from-internal]
; Internal extension calls (1xxx)
exten => _1XXX,1,NoOp(Internal call to ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN},30)
 same => n,Hangup()

; ==================
; Outbound GSM calls
; Uses g0 (group 0) to auto-select any available modem
; VOLUME(TX)=-20 prevents audio saturation on WebRTC â†’ GSM bridge
; ==================

; French mobile numbers (06XX, 07XX)
exten => _06XXXXXXXX,1,NoOp(Outbound mobile to ${EXTEN})
 same => n,Set(VOLUME(TX)=-20)
 same => n,Dial(Quectel/g0/${EXTEN},120,g)
 same => n,Hangup()

exten => _07XXXXXXXX,1,NoOp(Outbound mobile to ${EXTEN})
 same => n,Set(VOLUME(TX)=-20)
 same => n,Dial(Quectel/g0/${EXTEN},120,g)
 same => n,Hangup()

; French landline (05XX)
exten => _05XXXXXXXX,1,NoOp(Outbound landline to ${EXTEN})
 same => n,Set(VOLUME(TX)=-20)
 same => n,Dial(Quectel/g0/${EXTEN},120,g)
 same => n,Hangup()

; International format +590 (Guadeloupe)
exten => _+590XXXXXXXXX,1,NoOp(Outbound intl to ${EXTEN})
 same => n,Set(VOLUME(TX)=-20)
 same => n,Dial(Quectel/g0/0${EXTEN:4},120,g)
 same => n,Hangup()

; Generic international +XX...
exten => _+X.,1,NoOp(Outbound international to ${EXTEN})
 same => n,Set(VOLUME(TX)=-20)
 same => n,Dial(Quectel/g0/${EXTEN},120,g)
 same => n,Hangup()

; Generic 0X. pattern (catch-all for French numbers)
exten => _0X.,1,NoOp(Outbound GSM to ${EXTEN})
 same => n,Set(VOLUME(TX)=-20)
 same => n,Dial(Quectel/g0/${EXTEN},120,g)
 same => n,Hangup()

; ==================
; Test Extensions
; ==================

; Echo test (600) - hear your own voice
exten => 600,1,NoOp(Echo test)
 same => n,Answer()
 same => n,Playback(demo-echotest)
 same => n,Echo()
 same => n,Hangup()

; Talking clock (601)
exten => 601,1,NoOp(Talking clock)
 same => n,Answer()
 same => n,SayUnixTime()
 same => n,Hangup()

; Test tone (602)
exten => 602,1,NoOp(Test tone)
 same => n,Answer()
 same => n,MusicOnHold(default,30)
 same => n,Hangup()

; ==================
; Incoming calls from GSM
; Ring group behavior with push notification support
; - Sends Ringing() to caller (they hear ringback tone)
; - Waits up to 25 seconds for app to register via push notification
; - Then rings all extensions for 45 seconds
; - Falls back to voicemail if no answer
; ==================

[from-gsm]
exten => s,1,NoOp(=== INCOMING GSM CALL from ${CALLERID(num)} ===)
 same => n,Set(CALLERID(name)=GSM ${CALLERID(num)})
 same => n,Ringing()
 same => n,Set(i=0)
 same => n(loop),Set(i=$[${i}+1])
 same => n,GotoIf($[${i} > 25]?dial)
 same => n,Set(STATUS=${DEVICE_STATE(PJSIP/1000)})
 same => n,NoOp(Waiting for app... attempt ${i}/25, status=${STATUS})
 same => n,GotoIf($["${STATUS}" = "NOT_INUSE" | "${STATUS}" = "INUSE"]?dial)
 same => n,Wait(1)
 same => n,Goto(loop)
 same => n(dial),NoOp(Dialing extensions...)
 same => n,Set(VOLUME(RX)=-10)
 same => n,Dial(PJSIP/1000,45,rt)
 same => n,Congestion()
 same => n,Hangup()

; Invalid extension handler
exten => i,1,NoOp(Invalid extension ${EXTEN})
 same => n,Playback(invalid)
 same => n,Hangup()
